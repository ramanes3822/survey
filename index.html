<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Smart-retail-test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="style.css">
  </head>
  <body>
    
    <div class="banner">
      <img src="assets/1738.jpg" alt="banner image">
    </div>
    <div class="rewards-text"><p>Submit to get rewards</p></div>
    <div class="form-container">
      <form id="register-form" action="https://6ce6-175-139-147-209.ngrok-free.app/api/smart-engage/post/get-rewards-line" method="post">
        <input type="hidden" name="coupon-id" value="569">
        <label for="country-code">Country code:</label>
        <select id="country-code" name="country-code">
          <option value="65">Singapore(+65)</option>
          <option value="852">Hong Kong (+852)</option>
          <option value="81">Japan (+81)</option>
          <option value="60">Malaysia (+60)</option>
        </select>
        <label for="phone-number">Phone number:</label>
        <input type="text" id="phone-number" name="phone-number" placeholder="Enter phone number">
        <input type="submit" value="Submit">
      </form>
      <div id="response-message"></div>
    </div>
    <script>
      const form = document.getElementById('register-form')
      const responseMessage = document.getElementById('response-message')
      const chanelId = '@384eqggz';

      form.addEventListener('submit', async(event)=>{
        event.preventDefault();

        //concatenate country code and phone number
        const countryCode = document.getElementById('country-code').value;
        const phoneNumber = document.getElementById('phone-number').value;
        const fullPhoneNumber = countryCode + phoneNumber;

        const formData = {
          'coupon-id': form.elements['coupon-id'].value,
          'phone-number': fullPhoneNumber,
          'type': 'redeem_request'
        }

        const reponse = await fetch(form.action, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });
        const responseData = await reponse.json();
        
        //redirect to another page if response is not_registered
      
        if(responseData.message === 'not_registered'){
          console.log(responseData.message)
          responseMessage.textContent = "You have not registered yet!, we will redirect to your line account to register";
          responseMessage.style.color = "blue";
          await new Promise(resolve => setTimeout(resolve, 1000));
          
          const redirectURL = 'https://line.me/R/oaMessage/'+chanelId+'/?Kindly%20"PRESS"%20send%20to%20register%20your%20Device%0A%5BPhoneNum:' +fullPhoneNumber+',%0AMode:Register%5D';
    
          window.location.href = redirectURL;
        }
        else if(responseData.message === 'coupon_used'){
          responseMessage.textContent = "You have already used this coupon!";
        }
        else if(responseData.message === 'success'){
          responseMessage.textContent = "You have successfully redeemed the coupon!";
        }
        else{
          responseMessage.textContent = "Something went wrong!";
          responseMessage.style.color = "red";
        }
      })
    </script>

  </body>
</html>
